{"timestamp": 1769614266.306929, "stored_source_code": "# declare a list tasks whose products you want to use as inputs\nupstream = None\n\n#pip install duckdb pandas numpy matplotlib requests python-dotenv jupysql duckdb-engine scikit-learn fastapi\n\n# flake8: noqa\nimport duckdb\nimport requests\nimport os\nfrom dotenv import load_dotenv\ndef init_duck_db_movies(duckdb_file_path, res):\n    \"\"\"\n    Create table for movies API call in DuckDB\n    If the table exists, new data is inserted\n\n    Parameters\n    ----------\n    duckdb_file_path : str\n        Path to the DuckDB database file\n    res : requests object\n        API call results\n    \"\"\"\n    try:\n        conn = duckdb.connect(duckdb_file_path, read_only=False)\n\n        tables = conn.execute(\"SHOW TABLES;\").fetchall()\n        if (\"movies\",) not in tables:\n            conn.execute(\n                \"\"\"\n                CREATE TABLE movies (\n                    genre_ids INT[],\n                    id INTEGER,\n                    original_language VARCHAR,\n                    overview VARCHAR,\n                    popularity DOUBLE,\n                    release_date TIMESTAMP,\n                    title VARCHAR,\n                    vote_average DOUBLE,\n                    vote_count INTEGER\n                );\n            \"\"\"\n            )\n\n        for movie in res[\"results\"]:\n            genre_ids_str = \",\".join(map(str, movie[\"genre_ids\"]))\n            conn.execute(\n                f\"\"\"\n                INSERT INTO movies VALUES (ARRAY[{genre_ids_str}], {movie['id']},\n                '{movie['original_language']}',\n                '{movie['overview'].replace(\"'\", \"''\")}',\n                {movie['popularity']},\n                '{movie['release_date']}',\n                '{movie['title'].replace(\"'\", \"''\")}',\n                {movie['vote_average']},\n                {movie['vote_count']});\n            \"\"\"\n            )\n\n        conn.close()\n\n    except Exception as e:\n        print(e)\ndef init_duck_db_genres(duckdb_file_path, genres_data):\n    \"\"\"\n    Create table for genres API call in DuckDB\n    If the table exists, new data is inserted\n\n    Parameters\n    ----------\n    duckdb_file_path : str\n        Path to the DuckDB database file\n    genres_data : list\n        List of genres\n\n    \"\"\"\n    try:\n        conn = duckdb.connect(duckdb_file_path, read_only=False)\n\n        tables = conn.execute(\"SHOW TABLES;\").fetchall()\n        if (\"genres\",) not in tables:\n            conn.execute(\n                \"\"\"\n                CREATE TABLE genres (\n                    id INTEGER,\n                    name VARCHAR\n                );\n            \"\"\"\n            )\n\n        for genre in genres_data:\n            conn.execute(\n                f\"\"\"\n                INSERT INTO genres VALUES ({genre['id']},\n                '{genre['name']}');\n            \"\"\"\n            )\n\n        conn.close()\n\n    except Exception as e:\n        print(e)\ndef drop_existing_movies_table(duckdb_file_path):\n    \"\"\"\n    Drops existing movies tables\n\n    Parameters\n    ----------\n    duckdb_file_path : str\n        Path to the DuckDB database file\n    \"\"\"\n    try:\n        conn = duckdb.connect(duckdb_file_path, read_only=False)\n\n        movies_table_exists = conn.execute(\n            \"SELECT 1 FROM information_schema.tables WHERE table_name = 'movies'\"\n        ).fetchone()\n\n        if movies_table_exists:\n            conn.execute(\"DROP TABLE movies;\")\n            print(\"Table 'movies' dropped.\")\n        else:\n            print(\"Table 'movies' does not yet exist. Creating 'movies' now.\")\n\n        conn.close()\n\n    except Exception as e:\n        print(e)\ndef drop_existing_genres_table(duckdb_file_path):\n    \"\"\"\n    Drops existing genres table\n\n    Parameters\n    ----------\n    duckdb_file_path : str\n        Path to the DuckDB database file\n    \"\"\"\n    try:\n        conn = duckdb.connect(duckdb_file_path, read_only=False)\n\n        genres_table_exists = conn.execute(\n            \"SELECT 1 FROM information_schema.tables WHERE table_name = 'genres'\"\n        ).fetchone()\n\n        if genres_table_exists:\n            conn.execute(\"DROP TABLE genres;\")\n            print(\"Table 'genres' dropped.\")\n        else:\n            print(\"Table 'genres' does not yet exist. Creating 'genres' now.\")\n\n        conn.close()\n\n    except Exception as e:\n        print(e)\ndef get_movies(lang, freq, duckdb_file_path, api_key):\n    \"\"\"\n    Inserts API call results into DuckDB\n\n    Parameters\n    ----------\n    lang : str\n        Language of movies\n    freq : int\n        Amount of movies to extract\n    duckdb_file_path : str\n        Path to the DuckDB database file\n    api_key : str\n        API key for The Movie Database\n    \"\"\"\n    url = \"https://api.themoviedb.org/3/movie/popular?api_key={api_key}&with_original_language={lang}\".format(  # noqa E501\n        api_key=api_key, lang=lang\n    )\n    movies = 0\n    page = 1\n    progress = 0\n\n    drop_existing_movies_table(duckdb_file_path)\n\n    while movies < freq:\n        try:\n            res = requests.get(url + \"&page=\" + str(page))\n        except requests.exceptions.RequestException as e:\n            print(\"An error occurred during the request:\", e)\n            break\n        if res.status_code != 200:\n            print(\"error\")\n            return []\n\n        res = res.json()\n\n        if \"errors\" in res.keys():\n            print(\"api error !!!\")\n            return movies\n\n        movies += len(res[\"results\"])\n\n        init_duck_db_movies(duckdb_file_path, res)\n\n        if progress != round(movies / freq * 100):\n            progress = round(movies / freq * 100)\n            if progress % 5 == 0:\n                print(progress, end=\"%, \")\n\n        page = page + 1\n    return movies\ndef get_genres(lang, duckdb_file_path, api_key):\n    \"\"\"\n    Inserts API call results into DuckDB\n\n    Parameters\n    ----------\n    lang : str\n        Language of movies\n    freq : int\n        Amount of movies to extract\n    duckdb_file_path : str\n        Path to the DuckDB database file\n    api_key : str\n        API key for The Movie Database\n    \"\"\"\n    url = \"https://api.themoviedb.org/3/genre/movie/list?api_key={api_key}&with_original_language={lang}\".format(  # noqa E501\n        api_key=api_key, lang=lang\n    )\n\n    drop_existing_genres_table(duckdb_file_path)\n\n    try:\n        res = requests.get(url)\n    except requests.exceptions.RequestException as e:\n        print(\"An error occurred during the request:\", e)\n        return []\n\n    if res.status_code != 200:\n        print(\"error\")\n        return []\n\n    res = res.json()\n\n    if \"errors\" in res.keys():\n        print(\"api error !!!\")\n        return []\n\n    genres_data = res[\"genres\"]\n    init_duck_db_genres(duckdb_file_path, genres_data)\n\n    return len(genres_data)\nif __name__ == \"__main__\":\n    # Parameter to get 500 English movies\n    language_count = {\n        \"en\": 1000,\n    }\n\n    load_dotenv(\".env\")\n    api_key = os.getenv(\"API_KEY\")\n\n    for key in language_count:\n        # print(key,language_count[key])\n        print(\"Downloading\", key, end=\": \")\n        movies = get_movies(\n            key, language_count[key], \"movie_rec_system/movies_data.duckdb\", api_key\n        )  # noqa E501\n        print(\"Total movies found:\", movies)\n        genres = get_genres(key, \"movie_rec_system/movies_data.duckdb\", api_key)\n        print(\"Total genres found:\", genres)", "params": {}}